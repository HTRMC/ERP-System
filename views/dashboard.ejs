<!DOCTYPE html>
<html>
  <head>
    <title>Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
    <link rel="stylesheet" href="/css/style-dashboard.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="main-container">
      <div class="container">
        <div class="sidebar-container">
          <div class="menu-container">
            <div class="top-menu-container">
              <div class="menu-icon">
                <img src="/images/hamburger.png" alt="menu-knop" draggable="false"/>
              </div>
              <div class="logo">
                <img src="/images/logo.png" alt="Logo" draggable="false"/>
              </div>
            </div>
            <div class="bottom-menu-container">
              <div class="dashboard-container">
                <a href="/dashboard" class="dashboard">
                  <i class="icon-dashboard"></i>
                  <span>Dashboard</span>
                </a>
              </div>
            </div>
          </div>
          <div class="sidebar-menu">
            <ul>
              <li>
                <a href="/projects">
                  <i class="icon-ui-elements"></i>
                  <span>Projecten</span>
                </a>
              </li>
              <% if (user.role_id === 3) { %>
              <li>
                <a href="/users">
                  <i class="icon-form-elements"></i>
                  <span>Gebruikers</span>
                </a>
              </li>
              <% } %>
              <li>
                <a href="/reports/hours">
                  <i class="icon-tables"></i>
                  <span>Rapporten</span>
                </a>
              </li>
              <li>
                <a href="/invoices">
                  <i class="icon-icons"></i>
                  <span>Facturen</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
        <div class="main-content-container">
          <div class="search-container">
            <div class="search-container-left">
              <div class="message-container">
                <div class="welcome-massage">
                  <h2>Welkom, <%= user.name %></h2>
                </div>
                <div class="additional-massage"></div>
              </div>
            </div>
            <div class="search-container-right">
              <div class="search-bar-container">
                <div class="search-bar">
                  <i class="fas fa-search"></i>
                  <input type="search" name="search" placeholder="Zoeken" />
                </div>
              </div>
              <div class="account-button">
                <div class="circle"></div>
              </div>
            </div>
          </div>
          <div class="content-container">
            <div class="general-container">
              <div>
                <p class="title">Uren Jaarbasis</p>
                <h3 class="Tijd"><%= typeof totalHoursCurrentYear === 'number' ? totalHoursCurrentYear.toFixed(2) : '0.00' %> uur</h3>
              </div>
              <div>
                <p class="title">Inklok tijd</p>
                <h3 class="inklok-begin-tijd"><%= lastClockEntry ? new Date(lastClockEntry.clock_in_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'N/A' %></h3>
              </div>
              <div>
                <p class="title">Werktijd</p>
                <h3 class="werktijd" id="werktijd"><%= isClockedIn ? '00:00:00' : '--:--:--' %></h3>
              </div>
              <div>
                <p class="title">Ingeklokt</p>
                <h3 class="ingeklokt"><%= isClockedIn ? 'Ja' : 'Nee' %></h3>
              </div>
            </div>
            <div class="cards-container">
              <div class="links-cards-container">
                <div class="inklok-container">
                  <div class="inklok-boven">
                    <h4>Inklokken</h4>
                    <h5>Hier kan je inklokken</h5>
                  </div>
                  <div class="inklok-onder">
                    <div class="button-container">
                      <% if (!isClockedIn) { %>
                      <form id="clock-in-form" action="/clock/clock-in" method="post">
                        <div class="form-group">
                          <div class="label-container">
                            <label for="project_id">Project:</label>
                          </div>
                          <div class="select-container">
                            <select name="project_id" required>
                              <% projects.forEach(project => { %>
                                <option value="<%= project.id %>"><%= project.name %></option>
                              <% }) %>
                            </select>
                          </div>
                        </div>
                        <button type="submit">Inklokken</button>
                      </form>
                      <% } else { %>
                      <form id="clock-out-form" action="/clock/clock-out" method="post">
                        <div class="form-group">
                          <div class="label-container">
                            <label for="project_id">Project:</label>
                          </div>
                          <div class="select-container">
                            <select name="project_id" required>
                              <% projects.forEach(project => { %>
                                <option value="<%= project.id %>" <%= lastClockEntry && lastClockEntry.project_id === project.id ? 'selected' : '' %>><%= project.name %></option>
                              <% }) %>
                            </select>
                          </div>
                        </div>
                        <button type="submit">Uitklokken</button>
                      </form>
                      <% } %>
                    </div>
                  </div>
                </div>
                <div class="donut-card-container">
                  <canvas id="donutChart" width="400" height="400"></canvas>
                </div>
              </div>
              <div class="rechts-cards-container">
                <div class="opdrachten-card-container">
                  <h4>Projecten</h4>
                  <ul>
                    <% projects.forEach(project => { %>
                      <li><%= project.name %></li>
                    <% }) %>
                  </ul>
                </div>
                <div class="top-klant-container">
                  <h4>Top Klanten</h4>
                  <ul>
                    <% companiesWithProjectCount.forEach(company => { %>
                      <li><%= company.company_name %> - <%= company.project_count %> projecten</li>
                    <% }) %>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const hoursByProject = <%- JSON.stringify(hoursByProject || []) %>;
        const lastClockInTime = <%- JSON.stringify(lastClockEntry ? lastClockEntry.clock_in_time : null) %>;
        const isClockedIn = <%= isClockedIn %>;

        const labels = hoursByProject.map(entry => entry.project_name);
        const data = hoursByProject.map(entry => entry.hours_worked);

        const projects = {
          labels: labels,
          datasets: [
            {
              label: "Hours Worked",
              data: data,
              backgroundColor: [
                "rgba(255, 99, 132, 0.5)",
                "rgba(54, 162, 235, 0.5)",
                "rgba(255, 206, 86, 0.5)",
                "rgba(75, 192, 192, 0.5)",
                "rgba(153, 102, 255, 0.5)",
                "rgba(255, 159, 64, 0.5)",
              ],
              borderColor: [
                "rgba(255, 99, 132, 1)",
                "rgba(54, 162, 235, 1)",
                "rgba(255, 206, 86, 1)",
                "rgba(75, 192, 192, 1)",
                "rgba(153, 102, 255, 1)",
                "rgba(255, 159, 64, 1)",
              ],
              borderWidth: 1,
            },
          ],
        };

        const donutChartCanvas = document.getElementById("donutChart");
        const donutChart = new Chart(donutChartCanvas, {
          type: "doughnut",
          data: projects,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed !== null) {
                      label += context.parsed.toFixed(1) + ' hours';
                    }
                    return label;
                  }
                }
              }
            }
          }
        });

        if (isClockedIn && lastClockInTime) {
          const clockInTime = new Date(lastClockInTime);
          setInterval(() => {
            const now = new Date();
            const diff = new Date(now - clockInTime);
            const hours = String(diff.getUTCHours()).padStart(2, '0');
            const minutes = String(diff.getUTCMinutes()).padStart(2, '0');
            const seconds = String(diff.getUTCSeconds()).padStart(2, '0');
            document.getElementById('werktijd').textContent = `${hours}:${minutes}:${seconds}`;
          }, 1000);
        }
      });
    </script>
  </body>
</html>
